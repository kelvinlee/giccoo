var app,config,express,fs,maxAge,path,routes,staticDir;path=require("path"),express=require("express"),config=require("./config").config,routes=require("./routes"),fs=require("fs"),app=express(),app.configure(function(){var e;return e=path.join(__dirname,"views"),app.set("view engine","jade"),app.set("views",e),app.use(express.cookieParser()),app.use(express.session({secret:config.session_secret})),app.use(express.urlencoded()),app.use(express.json()),app.use(express.bodyParser({keepExtensions:!0,uploadDir:config.upload})),app.use(require("./controllers/user").auth_user),app.use(function(e,s,a){return e.body&&"pull"===e.body.git?a():(app.use(express.csrf()),a())}),app.use(function(e,s,a){return s.locals.token=e.session._csrf,a()})}),app.use(function(e,s,a){var r,p;return p=e.session.messages||[],s.locals.messages=p,s.locals.hasMessages=!!p.length,s.locals({messages:p,hasMessages:!!p.length}),e.session.messages=[],s.locals.config=config,r="en-US",s.locals.l=require("./language/en-US.js"),s.locals.language=r,e.acceptedLanguages.length>0&&fs.exists("./language/"+e.acceptedLanguages[0]+".js",function(a){return a?(s.locals.l=require("./language/"+e.acceptedLanguages[0]),s.locals.language=e.acceptedLanguages[0]):void 0}),a()}),maxAge=2592e6,staticDir=path.join(__dirname,"public"),app.configure("development",function(){return app.use(express["static"](staticDir)),app.use(express.errorHandler({dumpExceptions:!0,showStack:!0}))}),app.configure("production",function(){return app.use(express["static"](staticDir,{maxAge:maxAge})),app.set("view cache",!0)}),routes(app),app.listen(config.port,config.ip),console.log("Giccoo start.");