var EventProxy,TagWork,User,Ut,Work,check,config,converter,md;User=require("../proxy").User,Work=require("../proxy").Work,TagWork=require("../proxy").TagWork,check=require("validator").check,EventProxy=require("eventproxy"),config=require("../config").config,Ut=require("../lib/util"),md=require("showdown"),converter=new md.converter,exports.before=function(r,e,o){},exports.homepage=function(r,e,o){var t;return t=EventProxy.create("work","workcount","taglist","users",function(r,o,t,n){var a,i,u;for(a=i=0,u=n.length;u>=0?u>i:i>u;a=u>=0?++i:--i)n[a].avatar=Ut.avatar(n[a].email,280),n[a].description=converter.makeHtml(n[a].description);return e.render("homepage",{worklist:r,workcount:o,taglist:t,users:n})}),Work.getWorkPage(1,9,function(r,e,o){return t.emit("work",e),t.emit("workcount",{count:o,page:1,size:9})}),TagWork.getTagWorks(function(r,e){return t.emit("taglist",e)}),User.getUserAdmins(function(r,e){return t.emit("users",e)})},exports.works=function(r,e,o){},exports.work=function(r,e,o){return Work.getWorkByShortName(r.params.shortname,function(r,o){var t;return null!=o?(t=converter.makeHtml(o.content),e.render("work",{work:o,content:t}),o.visit_count++,o.save()):e.send({error:"404"})})},exports.works=function(r,e,o){var t;return t=r.params.page_num,Work.getWorkPage(t,9,function(r,o,n){return e.render("workpage",{worklist:o,workcount:{count:n,page:t,size:9}})})},exports.like=function(r,e,o){var t,n,a,i;return n=r.params.model,a=r.params.model_id,i=Ut.recode(),"true"===r.cookies[n+"-"+a]&&(i.recode=201,i.reason="already have."),"work"===n&&200===i.recode&&(t=6048e5,e.cookie(n+"-"+a,"true",{expires:new Date(Date.now()+604800,{maxAge:t})}),Work.getWorkById(a,function(r,e){return e.like_count+=1,e.save()})),e.send(i)};