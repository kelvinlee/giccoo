var EventProxy,Menu,TagWork,User,Ut,Work,check,checkAdmin,config,fs,os;User=require("../proxy").User,Menu=require("../proxy").Menu,Work=require("../proxy").Work,TagWork=require("../proxy").TagWork,fs=require("fs"),Ut=require("../lib/util"),check=require("validator").check,EventProxy=require("eventproxy"),config=require("../config").config,os=require("os"),checkAdmin=function(e,r,o){var s,n;return r.locals.company={freemem:os.freemem(),totalmem:os.totalmem(),arch:os.arch(),type:os.type(),endianness:os.endianness(),cpus:os.cpus()},console.log("type",os.cpus()),e.session.is_admin&&e.cookies.user?(r.locals.avatar=Ut.avatar(e.session.email,26),r.locals.username=e.session.username,r.locals.userid=e.session.userid,o(),!0):(e.cookies.user?(n=Ut.decrypt(e.cookies.user,"giccoo"),s=n.split("	"),User.getUserById(s[0],function(s,n){return null!=n&&null!=n.is_admin&&n.is_admin?(e.session.is_admin=!0,e.session.userid=n._id,e.session.username=n.name,e.session.email=n.email,r.locals.avatar=Ut.avatar(n.email,26),r.locals.username=n.name,r.locals.userid=n._id,o()):r.redirect("/sign/in")})):r.redirect("/sign/in"),!1)},exports.before=function(e,r,o){return r.locals.active=["dashboard"],checkAdmin(e,r,o)},exports.homepage=function(e,r,o){return checkAdmin(e,r,function(){return r.render("admin/homepage")})},exports.work=function(e,r,o){return r.locals.active=["work","work-list"],Work.getWorks(r.locals.language,function(e,o){var s,n,t,i;for(s=[],n=t=0,i=o.length;i>=0?i>t:t>i;n=i>=0?++t:--t)null!=o[n].author_id?(o[n].author_id.avatar=Ut.avatar(o[n].author_id.email,24),s.push(o[n])):o[n].remove();return r.render("admin/work",{worklist:s})})},exports.workNew=function(e,r,o){return r.locals.active=["work","work-new"],fs.readdir(config.upload+"/"+e.session.userid+"/",function(o,s){return TagWork.getTagWorks(function(o,n){return r.render("admin/worknew",{taglist:n,avatar:Ut.avatar(e.session.email),files:s})})})},exports.workEdit=function(e,r,o){var s;return"new"===e.params.work_id?o():(r.locals.active=["work","work-list"],s=EventProxy.create("files","taglist","work",function(e,o,s){return r.render("admin/worknew",{taglist:o,avatar:Ut.avatar(s.author_id.email),edit:s,files:e})}),fs.readdir(config.upload+"/"+e.session.userid+"/",function(e,r){return s.emit("files",r)}),TagWork.getTagWorks(function(e,r){return s.emit("taglist",r)}),Work.getWorkById(e.params.work_id,function(e,r){return s.emit("work",r)}))},exports.workDel=function(e,r,o){var s,n;return s=e.params.work_id,n=Ut.recode(),Work.delWork(s,function(e,o){return r.send(n)})},exports.workEditPost=function(e,r,o){var s,n,t,i,a,d,u,c,l,m,g,f;return d=Ut.recode(),g=Ut.xss(null!=e.session.userid?e.session.userid:0),u=Ut.xss(e.body.shortname),m=Ut.xss(e.body.title),s=Ut.xss(e.body.editor),l=e.body.tagid,f=e.body.website,i=e.body.mobile,a=e.body.phonemodel,c=e.body.smallimg,n=e.body.img,t=e.acceptedLanguages.length>0?e.acceptedLanguages[0]:"zh-CN",Ut.empty(u)&&(d.recode=203,d.reason="miss short name"),Ut.empty(m)&&(d.recode=203,d.reason="miss title"),Ut.empty(c)&&(d.recode=203,d.reason="miss small image"),Ut.empty(s)&&(d.recode=203,d.reason="miss content"),Ut.empty(l)&&(d.recode=203,d.reason="miss tag"),i||n||(d.recode=203,d.reason="You must chace one from mobile or Image."),i&&!f&&(d.recode=203,d.reason="Mobile site must have a website url."),Ut.empty(t)&&(d.recode=203,d.reason="miss language"),200!==d.recode?(console.log("bug?"),void r.send(d)):Work.getWorkByShortName(u,function(o,t){return o?(d.recode=202,d.reason=o.message,r.send(d)):null===t||Ut.str(t._id)===e.params.work_id?Work.getWorkById(e.params.work_id,function(e,o){return o.shortname=u,o.title=m,o.content=s,o.tag_id=l,o.mobile=i,o.website=f,o.small_img=c,o.phone_model=a,o.img=n,o.save(),r.send(d)}):(d.recode=204,d.reason="already have shortname",r.send(d))})},exports.workNewPost=function(e,r,o){var s,n,t,i,a,d,u,c,l,m,g,f;return d=Ut.recode(),g=Ut.xss(null!=e.session.userid?e.session.userid:0),u=Ut.xss(e.body.shortname),m=Ut.xss(e.body.title),s=Ut.xss(e.body.editor),l=e.body.tagid,f=e.body.website,i=e.body.mobile,a=e.body.phonemodel,c=e.body.smallimg,n=e.body.img,t=e.acceptedLanguages.length>0?e.acceptedLanguages[0]:"zh-CN",Ut.empty(u)&&(d.recode=203,d.reason="miss short name"),Ut.empty(m)&&(d.recode=203,d.reason="miss title"),Ut.empty(c)&&(d.recode=203,d.reason="miss small image"),Ut.empty(s)&&(d.recode=203,d.reason="miss content"),Ut.empty(l)&&(d.recode=203,d.reason="miss tag"),i||n||(d.recode=203,d.reason="You must chace one from mobile or Image."),i&&!f&&(d.recode=203,d.reason="Mobile site must have a website url."),Ut.empty(t)&&(d.recode=203,d.reason="miss language"),200!==d.recode?r.send(d):Work.getWorkByShortName(u,function(e,o){return e?(d.recode=202,d.reason=e.message,r.send(d)):null!==o?(d.recode=201,d.reason="already have",r.send(d)):Work.newAndSave(u,m,s,g,t,l,i,f,n,a,c,function(e){return e&&(d.recode=204,d.reason=e.message),r.send(d)})})},exports.workTag=function(e,r,o){return r.locals.active=["work","work-tag-list"],TagWork.getTagWorks(function(e,o){return r.render("admin/worktag",{worktaglist:o})})},exports.workNewTag=function(e,r,o){return r.locals.active=["work","work-tag-new"],fs.readdir(config.upload+"/"+e.session.userid+"/",function(e,o){return r.render("admin/worknewtag",{files:o})})},exports.workDelTag=function(e,r,o){var s,n;return n=Ut.recode(),s=e.params.tag_id,TagWork.delTagWork(s,function(e,o){return console.log(e,o),r.send(n)})},exports.workNewTagPost=function(e,r,o){var s,n,t,i,a;return i=Ut.recode(),t=e.body.name,a=e.body.type,n=e.body.editor,s=null!=e.session.userid?e.session.userid:0,TagWork.getTagWorkByName(t,function(e,o){return console.log(e,o),e?(i.recode=202,i.reason=e.message,r.send(i)):Ut.empty(o)?TagWork.newAndSave(t,1,n,s,function(e){return e?(i.recode=203,i.reason=e.message):(i.recode=200,i.reason=r.locals.l.error.registersuccess),console.log(i),r.send(i)}):(i.recode=201,i.reason="already have",r.send(i)),r.send(i)})},exports.workTagEdit=function(e,r,o){return console.log("tag edit",e.params.tag_id),"new"===e.params.tag_id?o():(r.locals.active=["work","work-tag-list"],fs.readdir(config.upload+"/"+e.session.userid+"/",function(o,s){return TagWork.getTagWork(e.params.tag_id,function(e,o){return console.log(o),r.render("admin/worknewtag",{edit:o,files:s})})}))},exports.workEditTagPost=function(e,r,o){var s,n,t;return console.log("tag edit post",e.params.tag_id),"new"===e.params.tag_id?o():(t=Ut.recode(),n=e.body.name,s=e.body.editor,TagWork.updateTagWork(e.params.tag_id,function(e,o){return e&&(t.recode=203,t.reason=e.message),o.name=n,o.description=s,o.save(),r.send(t)}))},exports.pages=function(e,r,o){return console.log("pages"),r.render("admin/page")},exports.menu=function(e,r,o){return Menu.getMenus(function(e,o){return console.log(o),r.render("admin/menu",{menulist:o})})},exports.menuNew=function(e,r,o){return console.log("menu New"),r.render("admin/menu-new")},exports.menuPost=function(e,r,o){var s,n,t;return console.log(e.body),n=Ut.strim(e.body.menuname),t=Ut.strim(e.body.menuurl),s=Ut.strim(e.body.editor),console.log(n,t,s),n?t?s?(Menu.newAndSave(n,t,s,1,function(e){return e?o(e):(r.send({rescode:"200",reason:r.locals.l.error.registersuccess}),!0)}),!1):r.send({rescode:"201",reason:"error description"}):r.send({rescode:"201",reason:"error url"}):r.send({rescode:"201",reason:"error name"})},exports.userList=function(e,r,o){return r.locals.active=["user","user-list"],User.getUsers(function(e,o){var s,n,t;if(e)return console.log(e);for(s=n=0,t=o.length;t>=0?t>n:n>t;s=t>=0?++n:--n)o[s].avatar=Ut.avatar(o[s].email,24);return r.render("admin/user",{userlist:o})})},exports.userEdit=function(e,r,o){return r.locals.active=["user","user-list"],fs.readdir(config.upload+"/"+e.session.userid+"/",function(o,s){return User.getUserById(e.params.user_id,function(e,o){return o.avatar=Ut.avatar(o.email),r.render("admin/usernew",{edit:o,files:s})})})},exports.userDel=function(e,r,o){var s;return s=Ut.recode(),User.getUserById(e.params.user_id,function(e,o){return o.remove(function(){return r.send(s)})})},exports.userEditPost=function(e,r,o){var s,n,t,i,a,d,u,c,l,m,g,f,p;return g=Ut.recode(),m=Ut.xss(e.body.name),i=Ut.xss(e.body.email),l=Ut.xss(e.body.motto),p=Ut.xss(e.body.weibo),a=Ut.xss(e.body.facebook),f=Ut.xss(e.body.twitter),t=Ut.xss(e.body.dribbble),u=Ut.xss(e.body.instagram),d=Ut.xss(e.body.github),s=null!=e.body.active?!0:!1,c=null!=e.body.is_admin?!0:!1,n=Ut.xss(e.body.editor),Ut.empty(m)&&(g.recode=203,g.reason="miss name"),Ut.empty(i)&&(g.recode=203,g.reason="miss Email"),User.getUserById(e.params.user_id,function(o,k){return k.is_admin&&e.params.user_id+""!=e.session.userid+""?(g.recode=222,g.reason="You have no right to modify other users",r.send(g)):(k.name=m,k.email=i,k.motto=l,k.active=s,k.is_admin=c,k.description=n,k.social.weibo=p,k.social.facebook=a,k.social.twitter=f,k.social.dribbble=t,k.social.instagram=u,k.social.github=d,k.save(),r.send(g),k.active||k._isadmin?fs.mkdir(config.upload+"/"+k._id+"/",777,function(e){return console.log(e)}):void 0)})},exports.files=function(e,r,o){return r.locals.active=["files","files-list"],fs.readdir(config.upload+"/"+e.session.userid+"/",function(o,s){return console.log(o,s),null!=o?(fs.mkdir(config.upload+"/"+e.session.userid+"/",777,function(e){return console.log(e)}),r.render("admin/files",{files:[]})):r.render("admin/files",{files:s})})},exports.fileDel=function(e,r,o){var s;return s=Ut.recode(),fs.unlink(config.upload+"/"+e.session.userid+"/"+e.params.file_name,function(e){return e?(s.recode=209,s.reason=e,console.log(e)):r.send(s)})},exports.fileUpload=function(e,r,o){return r.locals.active=["files","files-upload"],r.render("admin/files-upload")},exports.fileUploadPost=function(e,r,o){var s,n,t;return n=Ut.recode(),t=e.files.file.path,s=e.files.file.name,fs.exists(config.upload+"/"+e.session.userid+"/",function(o){return o?fs.rename(t,config.upload+"/"+e.session.userid+"/"+s,function(){return r.send(n)}):fs.mkdir(config.upload+"/"+e.session.userid+"/",777,function(o){return fs.rename(t,config.upload+"/"+e.session.userid+"/"+s,function(){return r.send(n)})})})};